# Overview and Motivation

Ancilla manipulation allows us to do lots of things, from fairly simple applications like Fake Flippers to more complicated tricks like hookpushing. In many cases, you can simply memorize specific setups for tricks and get by just fine. So why bother learning this material in depth?

There are a few reasons. If you just memorize setups, it can be very hard to debug them without understanding what's happening. If you know what's going on, you can work out any problems you're having with a trick and become more consistent at it. Additionally, some tricks - especially hookpushing - have multiple things that need to be set up, and multiple ways to set those things up, and there is no realistic way to memorize every possible combination; understanding the mechanics will allow you to improvise with varied equipment.

And at least for me, it's just interesting to learn about!

This is ultimately a fairly dry and academic topic, but I think there's value in learning some of it.

## NOTE

This document is supposed to be **thorough** and **correct**; it is not meant, however, to discuss the implications of the facts it contains. [This tutorial document](ancilla_tutorial.md) is somewhat more concerned with examples and applications.

# How do ancillae spawn?

The process for everything but sparkles and arrows is like this:

1. Check for quota
1. Check for empty slot
1. Check for replaceable ancilla

Let's talk about the outliers first, and then discuss the normal cases.

### Sparkles

Sparkles try to spawn in the **back slots**, starting from 9. Sparkles are generated by the following:

    * Silver arrows in flight
    * Red boomerang
    * Sword charging
    * Ice rod[0]

Sparkles are also weird in that they're all handled distinctly; there isn't one "spawn_sparkle" routine that all these items reuse. But we can think of them as behaving pretty similarly to each other. I will not be addressing sparkles for the remainder of this section.

### Arrows

Arrows have [their own routine](https://github.com/spannerisms/jpdasm/blob/master/bank_09.asm#L6161) for all of this. Here's their algorithm:

1. If there's an arrow in flight, don't try to spawn
1. Check how many arrow-in-wall ancillae are present
1. If that number is not exactly 3:
    1. If there's an empty front slot, spawn there
    1. Otherwise give up
1. If there **are** exactly 3 arrow-in-wall ancillae:
    1. If the search index is currently 0, set it to 4
    1. If the ancilla at the current search index is an arrow-in-wall, replace it
    1. Otherwise, decrement the search index and try again

Several noteworthy things about this:

1. If you have 3 non-arrow-in-wall ancillae in front slots and you shoot 2 arrows, you will not be able to shoot a 3rd, because the replacement process only occurs if there are exactly 3 arrows in walls.
1. Arrows will never replace sparkles.
1. The search index will wrap itself around in the middle of this process, unlike other replacement routines.

I have also [transformed the assembly to pseudocode](AncillaAdd_ArrowFindSlot.md) if that's your thing.

## Check for quota

All ancillae have a maximum amount that the game wants to spawn. Before trying to spawn an ancilla, the game will scan the front slots (0-4) to see if that quota is already met. It will do this before trying to find a slot to spawn in. This is why, for example, you can't throw 2 boomerangs normally.

kan made a helpful table of all quotas and then hid it from us. I have brought it to the people for the first time, [you can see it here](ancilla_quotas.md).


## Check for empty slot

Most ancillae try to spawn in slot 4, and if they're unable to, they look at the next slot down, etc. In the course of normal gameplay, this substantially always works, and the ancilla spawns into its slot normally.

Bombs (and debris from bombing open certain doors[1]) behave the same but instead of starting at slot 4, they start at slot 1.

## Check for replaceable ancilla

If an ancilla cannot find an _empty_ slot to spawn in, it starts looking for a slot that has a _replaceable_ ancilla. 

The **replaceable ancillae** are:

    * Arrow-in-wall (these are a different ancilla than arrow-in-flight)
    * All kinds of sparkles

Here's the gist of how ancilla replacement works:

1. If the search index is zero, set it to this ancilla's quota + 1
1. Find the highest slot less than the search index that contains a replaceable ancilla
    * If you find one, replace that slot with the new ancilla
1. Give up when you run out of slots to check

The search index will end up with the value that points at the slot that was replaced, or zero if a replaceable ancilla was not found.

If you want the hairy details, [I wrote them up here](ancilla_replacement.md)

### Important Note

This process will not fill any empty slots that it encounters! It requires the presence of a replaceable ancilla. It was probably written with the assumption that it would only be called when all the slots less than the search index were already filled - a reasonable assumption for normal gameplay!

# Manipulating the Search Index

You'll note that the first check done when trying to fill a slot for an ancilla that wants to spawn is to check if the search index is zero. This means that if we can set it to a nonzero number, we can control what slot ancillae spawn in, or restrict their search space to avoid them spawning.

There are two main ways to manipulate the search index: setting it outright, and causing ancilla replacements on purpose to adjust it.

Causing ancilla replacements can be understood by carefully reading the above information.

## Setting the Search Index

[See here](setting_search_index.md)

---


[0] Silvers, red boom, and sword all generate `$3C` sparkles. Ice rod generates `$13` sparkles. They behave the same for our purposes.

[1] The debris thing is included only for completeness; it's basically irrelevant. The only usage of it that I'm aware of is for very-out-of-bounds memory manipulation in Delete Ganon.
